{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block header %}Admin Dashboard{% endblock %}

{% block content %}
<div class="nav">
    <a href="/admin">Trang ch·ªß</a>
    <a href="#" onclick="logout()">ƒêƒÉng xu·∫•t</a>
</div>

<div id="userInfo" class="card">
    <h3>Th√¥ng tin Admin</h3>
    <p id="userDetails">ƒêang t·∫£i...</p>
</div>

<div class="card">
    <h3>Qu·∫£n l√Ω s√°ch</h3>
    <button class="btn" onclick="showAddBookForm()">Th√™m s√°ch m·ªõi</button>
    
    <div id="addBookForm" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 5px;">
        <h4>Th√™m s√°ch m·ªõi</h4>
        <form onsubmit="addBook(event)">
            <div class="form-group">
                <label>T√™n s√°ch:</label>
                <input type="text" id="bookTitle" required>
            </div>
            <div class="form-group">
                <label>T√°c gi·∫£:</label>
                <input type="text" id="bookAuthor" required>
            </div>
            <div class="form-group">
                <label>ISBN:</label>
                <input type="text" id="bookISBN">
            </div>
            <div class="form-group">
                <label>S·ªë l∆∞·ª£ng:</label>
                <input type="number" id="bookQuantity" value="1" min="1" required>
            </div>
            <button type="submit" class="btn btn-success">L∆∞u</button>
            <button type="button" class="btn btn-secondary" onclick="hideAddBookForm()">H·ªßy</button>
        </form>
    </div>
    
    <!-- Search and Pagination Controls -->
    <div style="margin-top: 20px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
        <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm s√°ch theo t√™n ho·∫∑c t√°c gi·∫£..." 
               style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <button class="btn" onclick="searchBooks()">üîç T√¨m ki·∫øm</button>
        <button class="btn" onclick="resetSearch()" style="background: #6c757d;">‚Ü∫ Reset</button>
    </div>
    
    <div id="booksList">ƒêang t·∫£i...</div>
    
    <!-- Pagination Controls -->
    <div id="paginationControls" style="margin-top: 20px; text-align: center; display: none;">
        <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
            <button class="btn" id="prevBtn" onclick="previousPage()" style="padding: 8px 16px;">
                ‚Üê Trang tr∆∞·ªõc
            </button>
            <span id="pageInfo" style="padding: 0 20px; font-weight: bold;">
                Trang 1 / 1
            </span>
            <button class="btn" id="nextBtn" onclick="nextPage()" style="padding: 8px 16px;">
                Trang sau ‚Üí
            </button>
        </div>
        <div style="margin-top: 10px; color: #666;">
            <span id="totalInfo">T·ªïng s·ªë: 0 s√°ch</span>
        </div>
    </div>
</div>

<div class="card">
    <h3>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h3>
    <div id="usersList">ƒêang t·∫£i...</div>
</div>

<div class="card">
    <h3>Qu·∫£n l√Ω m∆∞·ª£n tr·∫£</h3>
    <div id="borrowsList">ƒêang t·∫£i...</div>
</div>

<script>
let currentUser = null;
let currentPage = 1;
let perPage = 5;
let currentSearch = '';

async function loadUserInfo() {
    currentUser = getCurrentUser();
    if (!currentUser || currentUser.role !== 'admin') {
        showAlert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y', 'error');
        setTimeout(() => window.location.href = '/login', 1000);
        return;
    }
    
    document.getElementById('userDetails').innerHTML = `
        <strong>H·ªç t√™n:</strong> ${currentUser.full_name}<br>
        <strong>T√™n ƒëƒÉng nh·∫≠p:</strong> ${currentUser.username}<br>
        <strong>Vai tr√≤:</strong> ${currentUser.role}
    `;
}

function showAddBookForm() {
    document.getElementById('addBookForm').style.display = 'block';
}

function hideAddBookForm() {
    document.getElementById('addBookForm').style.display = 'none';
    document.getElementById('bookTitle').value = '';
    document.getElementById('bookAuthor').value = '';
    document.getElementById('bookISBN').value = '';
    document.getElementById('bookQuantity').value = '1';
}

async function addBook(event) {
    event.preventDefault();
    
    try {
        await apiCall('/books', 'POST', {
            title: document.getElementById('bookTitle').value,
            author: document.getElementById('bookAuthor').value,
            isbn: document.getElementById('bookISBN').value,
            quantity: parseInt(document.getElementById('bookQuantity').value)
        });
        
        showAlert('Th√™m s√°ch th√†nh c√¥ng!', 'success');
        hideAddBookForm();
        loadBooks(1, currentSearch);
        
    } catch (error) {
        showAlert('L·ªói khi th√™m s√°ch: ' + error.message, 'error');
    }
}

async function loadBooks(page = 1, search = '') {
    try {
        // Build API URL with pagination and search
        let url = `/books/search?page=${page}&per_page=${perPage}`;
        if (search) {
            url += `&search=${encodeURIComponent(search)}`;
        }
        
        const result = await apiCall(url);
        const data = result.data;
        const books = data.items;
        const pagination = data.pagination;
        
        // Update current state
        currentPage = pagination.page;
        currentSearch = search;
        
        if (books.length === 0) {
            document.getElementById('booksList').innerHTML = '<p>Kh√¥ng t√¨m th·∫•y s√°ch n√†o.</p>';
            document.getElementById('paginationControls').style.display = 'none';
            return;
        }
        
        let html = '<table><thead><tr><th>ID</th><th>T√™n s√°ch</th><th>T√°c gi·∫£</th><th>ISBN</th><th>C√≤n l·∫°i</th><th>Thao t√°c</th></tr></thead><tbody>';
        
        books.forEach(book => {
            html += `
                <tr>
                    <td>${book.id}</td>
                    <td>${book.title}</td>
                    <td>${book.author}</td>
                    <td>${book.isbn || 'N/A'}</td>
                    <td>${book.available}/${book.quantity}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteBook('${book.id}', '${book.title}')">
                            X√≥a
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        document.getElementById('booksList').innerHTML = html;
        
        // Update pagination controls
        updatePaginationControls(pagination);
        
    } catch (error) {
        showAlert('L·ªói khi t·∫£i danh s√°ch s√°ch: ' + error.message, 'error');
    }
}

function updatePaginationControls(pagination) {
    const paginationDiv = document.getElementById('paginationControls');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageInfo = document.getElementById('pageInfo');
    const totalInfo = document.getElementById('totalInfo');
    
    // Show pagination only if there are results
    if (pagination.total > 0) {
        paginationDiv.style.display = 'block';
        
        // Update page info
        pageInfo.textContent = `Trang ${pagination.page} / ${pagination.total_pages}`;
        totalInfo.textContent = `T·ªïng s·ªë: ${pagination.total} s√°ch`;
        
        // Enable/disable buttons
        prevBtn.disabled = !pagination.has_prev;
        nextBtn.disabled = !pagination.has_next;
        
        // Update button styles
        prevBtn.style.opacity = pagination.has_prev ? '1' : '0.5';
        nextBtn.style.opacity = pagination.has_next ? '1' : '0.5';
        prevBtn.style.cursor = pagination.has_prev ? 'pointer' : 'not-allowed';
        nextBtn.style.cursor = pagination.has_next ? 'pointer' : 'not-allowed';
    } else {
        paginationDiv.style.display = 'none';
    }
}

function searchBooks() {
    const searchInput = document.getElementById('searchInput');
    const searchTerm = searchInput.value.trim();
    currentPage = 1; // Reset to first page when searching
    loadBooks(currentPage, searchTerm);
}

function resetSearch() {
    document.getElementById('searchInput').value = '';
    currentPage = 1;
    currentSearch = '';
    loadBooks(currentPage, '');
}

function previousPage() {
    if (currentPage > 1) {
        loadBooks(currentPage - 1, currentSearch);
    }
}

function nextPage() {
    loadBooks(currentPage + 1, currentSearch);
}

// Allow search on Enter key
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBooks();
            }
        });
    }
});

async function deleteBook(bookId, bookTitle) {
    if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s√°ch "${bookTitle}"?`)) {
        return;
    }
    
    try {
        await apiCall(`/books/${bookId}`, 'DELETE');
        showAlert('X√≥a s√°ch th√†nh c√¥ng!', 'success');
        loadBooks(currentPage, currentSearch);
    } catch (error) {
        showAlert('L·ªói khi x√≥a s√°ch: ' + error.message, 'error');
    }
}

async function loadUsers() {
    try {
        const result = await apiCall('/users');
        const users = result.data;
        
        let html = '<table><thead><tr><th>ID</th><th>T√™n ƒëƒÉng nh·∫≠p</th><th>H·ªç t√™n</th><th>Vai tr√≤</th></tr></thead><tbody>';
        
        users.forEach(user => {
            html += `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.full_name}</td>
                    <td>${user.role}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        document.getElementById('usersList').innerHTML = html;
        
    } catch (error) {
        showAlert('L·ªói khi t·∫£i danh s√°ch ng∆∞·ªùi d√πng: ' + error.message, 'error');
    }
}

async function loadBorrows() {
    try {
        const result = await apiCall('/borrows');
        const borrows = result.data;
        
        if (borrows.length === 0) {
            document.getElementById('borrowsList').innerHTML = '<p>Ch∆∞a c√≥ l·ªãch s·ª≠ m∆∞·ª£n tr·∫£.</p>';
            return;
        }
        
        // Load books and users
        const booksResult = await apiCall('/books');
        const usersResult = await apiCall('/users');
        const books = booksResult.data;
        const users = usersResult.data;
        
        let html = '<table><thead><tr><th>ID</th><th>Ng∆∞·ªùi m∆∞·ª£n</th><th>S√°ch</th><th>Ng√†y m∆∞·ª£n</th><th>H·∫°n tr·∫£</th><th>Tr·∫°ng th√°i</th></tr></thead><tbody>';
        
        borrows.forEach(borrow => {
            const book = books.find(b => b.id === borrow.book_id);
            const user = users.find(u => u.id === borrow.user_id);
            const borrowDate = new Date(borrow.borrow_date).toLocaleDateString('vi-VN');
            const dueDate = new Date(borrow.due_date).toLocaleDateString('vi-VN');
            
            html += `
                <tr>
                    <td>${borrow.id}</td>
                    <td>${user ? user.full_name : 'N/A'}</td>
                    <td>${book ? book.title : 'N/A'}</td>
                    <td>${borrowDate}</td>
                    <td>${dueDate}</td>
                    <td>${borrow.status === 'borrowed' ? 'üî¥ ƒêang m∆∞·ª£n' : 'üü¢ ƒê√£ tr·∫£'}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        document.getElementById('borrowsList').innerHTML = html;
        
    } catch (error) {
        showAlert('L·ªói khi t·∫£i danh s√°ch m∆∞·ª£n tr·∫£: ' + error.message, 'error');
    }
}

window.onload = function() {
    loadUserInfo();
    loadBooks();
    loadUsers();
    loadBorrows();
};
</script>
{% endblock %}

