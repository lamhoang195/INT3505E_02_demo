{% extends "base.html" %}

{% block title %}Dashboard - Ng∆∞·ªùi d√πng{% endblock %}

{% block header %}Dashboard - Ng∆∞·ªùi d√πng{% endblock %}

{% block content %}
<style>
    #borrowModal textarea {
        resize: vertical;
    }
    
    #borrowModal small {
        display: block;
        margin-top: 5px;
        font-size: 12px;
    }
    
    #borrowModal .form-group {
        margin-bottom: 15px;
    }
</style>

<div class="nav">
    <a href="/dashboard" style="background: #667eea;">Dashboard V6 (Donation)</a>
    <a href="/dashboard_v2">Dashboard V2 (HATEOAS)</a>
    <a href="#" onclick="logout()">ƒêƒÉng xu·∫•t</a>
</div>

<div id="userInfo" class="card">
    <h3>Th√¥ng tin ng∆∞·ªùi d√πng</h3>
    <p id="userDetails">ƒêang t·∫£i...</p>
</div>

<div class="card">
    <h3>Danh s√°ch s√°ch</h3>
    
    <!-- Search and Pagination Controls -->
    <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
        <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm s√°ch theo t√™n ho·∫∑c t√°c gi·∫£..." 
               style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <button class="btn" onclick="searchBooks()">üîç T√¨m ki·∫øm</button>
        <button class="btn" onclick="resetSearch()" style="background: #6c757d;">‚Ü∫ Reset</button>
    </div>
    
    <div id="booksList">ƒêang t·∫£i...</div>
    
    <!-- Pagination Controls -->
    <div id="paginationControls" style="margin-top: 20px; text-align: center; display: none;">
        <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
            <button class="btn" id="prevBtn" onclick="previousPage()" style="padding: 8px 16px;">
                ‚Üê Trang tr∆∞·ªõc
            </button>
            <span id="pageInfo" style="padding: 0 20px; font-weight: bold;">
                Trang 1 / 1
            </span>
            <button class="btn" id="nextBtn" onclick="nextPage()" style="padding: 8px 16px;">
                Trang sau ‚Üí
            </button>
        </div>
        <div style="margin-top: 10px; color: #666;">
            <span id="totalInfo">T·ªïng s·ªë: 0 s√°ch</span>
        </div>
    </div>
</div>

<div class="card">
    <h3>S√°ch ƒëang m∆∞·ª£n</h3>
    <div id="borrowedBooks">ƒêang t·∫£i...</div>
</div>

<!-- Modal for Borrow with Donation -->
<div id="borrowModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: white; margin: 10% auto; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
        <h2 style="color: #667eea; margin-bottom: 20px;">M∆∞·ª£n s√°ch: <span id="borrowBookTitle"></span></h2>
        
        <div class="form-group">
            <label for="donationAmount">S·ªë ti·ªÅn donate (VNƒê) - T√πy ch·ªçn:</label>
            <input type="number" id="donationAmount" min="0" step="1000" placeholder="Nh·∫≠p s·ªë ti·ªÅn (v√≠ d·ª•: 50000)">
            <small style="color: #666;">B·∫°n c√≥ th·ªÉ donate ti·ªÅn ƒë·ªÉ h·ªó tr·ª£ th∆∞ vi·ªán duy tr√¨ ho·∫°t ƒë·ªông</small>
        </div>
        
        <div class="form-group">
            <label for="donationMessage">L·ªùi nh·∫Øn (T√πy ch·ªçn):</label>
            <textarea id="donationMessage" rows="3" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px; font-family: inherit;" placeholder="Nh·∫≠p l·ªùi nh·∫Øn c·ªßa b·∫°n..."></textarea>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="closeBorrowModal()">H·ªßy</button>
            <button class="btn btn-success" onclick="borrowBook()">X√°c nh·∫≠n m∆∞·ª£n</button>
        </div>
    </div>
</div>

<script>
let currentUser = null;
let currentPage = 1;
let perPage = 5;
let currentSearch = '';

async function loadUserInfo() {
    currentUser = getCurrentUser();
    if (!currentUser) {
        window.location.href = '/login';
        return;
    }
    
    document.getElementById('userDetails').innerHTML = `
        <strong>H·ªç t√™n:</strong> ${currentUser.full_name}<br>
        <strong>T√™n ƒëƒÉng nh·∫≠p:</strong> ${currentUser.username}<br>
        <strong>Vai tr√≤:</strong> ${currentUser.role}
    `;
}

async function loadBooks(page = 1, search = '') {
    try {
        // Build API URL with pagination and search
        let url = `/books/search?page=${page}&per_page=${perPage}`;
        if (search) {
            url += `&search=${encodeURIComponent(search)}`;
        }
        
        const result = await apiCall(url);
        const data = result.data;
        const books = data.items;
        const pagination = data.pagination;
        
        // Update current state
        currentPage = pagination.page;
        currentSearch = search;
        
        if (books.length === 0) {
            document.getElementById('booksList').innerHTML = '<p>Kh√¥ng t√¨m th·∫•y s√°ch n√†o.</p>';
            document.getElementById('paginationControls').style.display = 'none';
            return;
        }
        
        let html = '<table><thead><tr><th>T√™n s√°ch</th><th>T√°c gi·∫£</th><th>ISBN</th><th>C√≤n l·∫°i</th><th>Thao t√°c</th></tr></thead><tbody>';
        
        books.forEach(book => {
            html += `
                <tr>
                    <td>${book.title}</td>
                    <td>${book.author}</td>
                    <td>${book.isbn || 'N/A'}</td>
                    <td>${book.available}/${book.quantity}</td>
                    <td>
                        <button class="btn btn-success" onclick="showBorrowModal('${book.id}', '${book.title.replace(/'/g, "\\'")}')" ${book.available <= 0 ? 'disabled' : ''}>
                            M∆∞·ª£n s√°ch
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        document.getElementById('booksList').innerHTML = html;
        
        // Update pagination controls
        updatePaginationControls(pagination);
        
    } catch (error) {
        showAlert('L·ªói khi t·∫£i danh s√°ch s√°ch: ' + error.message, 'error');
    }
}

function updatePaginationControls(pagination) {
    const paginationDiv = document.getElementById('paginationControls');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageInfo = document.getElementById('pageInfo');
    const totalInfo = document.getElementById('totalInfo');
    
    // Show pagination only if there are results
    if (pagination.total > 0) {
        paginationDiv.style.display = 'block';
        
        // Update page info
        pageInfo.textContent = `Trang ${pagination.page} / ${pagination.total_pages}`;
        totalInfo.textContent = `T·ªïng s·ªë: ${pagination.total} s√°ch`;
        
        // Enable/disable buttons
        prevBtn.disabled = !pagination.has_prev;
        nextBtn.disabled = !pagination.has_next;
        
        // Update button styles
        prevBtn.style.opacity = pagination.has_prev ? '1' : '0.5';
        nextBtn.style.opacity = pagination.has_next ? '1' : '0.5';
        prevBtn.style.cursor = pagination.has_prev ? 'pointer' : 'not-allowed';
        nextBtn.style.cursor = pagination.has_next ? 'pointer' : 'not-allowed';
    } else {
        paginationDiv.style.display = 'none';
    }
}

function searchBooks() {
    const searchInput = document.getElementById('searchInput');
    const searchTerm = searchInput.value.trim();
    currentPage = 1; // Reset to first page when searching
    loadBooks(currentPage, searchTerm);
}

function resetSearch() {
    document.getElementById('searchInput').value = '';
    currentPage = 1;
    currentSearch = '';
    loadBooks(currentPage, '');
}

function previousPage() {
    if (currentPage > 1) {
        loadBooks(currentPage - 1, currentSearch);
    }
}

function nextPage() {
    loadBooks(currentPage + 1, currentSearch);
}

// Allow search on Enter key
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBooks();
            }
        });
    }
});


async function loadBorrowedBooks() {
    try {
        const result = await apiCall(`/borrows?user_id=${currentUser.id}&status=active`);
        const borrows = result.data;
        
        if (borrows.length === 0) {
            document.getElementById('borrowedBooks').innerHTML = '<p>B·∫°n ch∆∞a m∆∞·ª£n s√°ch n√†o.</p>';
            return;
        }
        
        // Load book details
        const booksResult = await apiCall('/books');
        const books = booksResult.data;
        
        let html = '<table><thead><tr><th>T√™n s√°ch</th><th>Ng√†y m∆∞·ª£n</th><th>H·∫°n tr·∫£</th><th>Thao t√°c</th></tr></thead><tbody>';
        
        borrows.forEach(borrow => {
            const book = books.find(b => b.id === borrow.book_id);
            const borrowDate = new Date(borrow.borrow_date).toLocaleDateString('vi-VN');
            const dueDate = new Date(borrow.due_date).toLocaleDateString('vi-VN');
            
            html += `
                <tr>
                    <td>${book ? book.title : 'N/A'}</td>
                    <td>${borrowDate}</td>
                    <td>${dueDate}</td>
                    <td>
                        <button class="btn btn-danger" onclick="returnBook('${borrow.id}')">
                            Tr·∫£ s√°ch
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        document.getElementById('borrowedBooks').innerHTML = html;
        
    } catch (error) {
        showAlert('L·ªói khi t·∫£i danh s√°ch s√°ch ƒë√£ m∆∞·ª£n: ' + error.message, 'error');
    }
}

// Modal for borrow with donation
let currentBorrowBookId = null;

function showBorrowModal(bookId, bookTitle) {
    currentBorrowBookId = bookId;
    document.getElementById('borrowBookTitle').textContent = bookTitle;
    document.getElementById('donationAmount').value = '';
    document.getElementById('donationMessage').value = '';
    document.getElementById('borrowModal').style.display = 'block';
}

function closeBorrowModal() {
    document.getElementById('borrowModal').style.display = 'none';
    currentBorrowBookId = null;
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('borrowModal');
    if (event.target == modal) {
        closeBorrowModal();
    }
}

async function borrowBook() {
    if (!currentBorrowBookId) return;
    
    try {
        const donationAmount = parseFloat(document.getElementById('donationAmount').value) || 0;
        const donationMessage = document.getElementById('donationMessage').value || '';
        
        // Use V6 API for borrow with donation
        const response = await fetch('http://localhost:5000/api/v6/borrows', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: currentUser.id,
                book_id: currentBorrowBookId,
                donation_amount: donationAmount,
                donation_message: donationMessage
            })
        });
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.message || 'An error occurred');
        }
        
        let message = 'M∆∞·ª£n s√°ch th√†nh c√¥ng!';
        if (result.data.donation) {
            message += ` C·∫£m ∆°n b·∫°n ƒë√£ donate ${result.data.donation.amount.toLocaleString('vi-VN')} VNƒê cho th∆∞ vi·ªán!`;
        }
        
        showAlert(message, 'success');
        closeBorrowModal();
        loadBooks();
        loadBorrowedBooks();
        
    } catch (error) {
        showAlert('L·ªói khi m∆∞·ª£n s√°ch: ' + error.message, 'error');
    }
}

async function returnBook(borrowId) {
    try {
        await apiCall(`/borrows/${borrowId}/return`, 'POST');
        
        showAlert('Tr·∫£ s√°ch th√†nh c√¥ng!', 'success');
        loadBooks();
        loadBorrowedBooks();
        
    } catch (error) {
        showAlert('L·ªói khi tr·∫£ s√°ch: ' + error.message, 'error');
    }
}

window.onload = function() {
    loadUserInfo();
    loadBooks();
    loadBorrowedBooks();
};
</script>
{% endblock %}

